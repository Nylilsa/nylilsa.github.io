[title=FW: Point Item Value Overflow Glitch]
# Point Item Value Overflow Glitch
[hr_major]

## [specs]  
[hr_minor]

* **Versions**: [yes]1.00c[/yes]
* **Difficulty**: [yes]Easy[/yes] - [yes]Normal[/yes] - [yes]Hard[/yes] - [yes]Lunatic[/yes] - [yes]Extra[/yes]
* **Mode**: [yes]Main game[/yes] - [yes]Practice mode[/yes] - [yes]Spell practice[/yes]  
* **Shottype**: [yes]Reimu[/yes] - [yes]Marisa[/yes]

## [what]
[hr_minor]


The Point Item Value (PIV) is the value used for representing the score value of a Point Item at its maximum value. The PIV is also known as the "Incident Value" in this game, but for simplicity it will be called PIV. This value can range from ``0.00`` to ``200.00``.

When the PIV is within ``[42.95; 85.4]`` or ``[128.85; 171.30]``, the score obtained from collecting a point item will be exactly 10 score. This bug cannot be avoided without the use of any third party tools.

[img=bugs/th20/0_piv.jpg, figtitle=Screenshot showing a bugged PIV value of 65.70 , alt=A screenshot showing a bugged value]

## [how]
[hr_minor]

To replicate this bug, simply play the game until your PIV is within ``[42.95; 85.4]`` or ``[128.85; 171.30]``. [hl2]This bug also exists in replays[/hl2], meaning if you watch a replay that has a PIV within the bugged range any point items will give 10 score.

## [why]
[hr_minor]

<!-- explain internal piv structure -->
Within ``th20.exe``, the PIV value is not stored as a value between ``[0.00; 200.00]``. Instead, [hl2]the PIV is stored as a value between ``[0; 1,000,000]``[/hl2], which I will call the [hl2]internal PIV[/hl2]. The value that you are seeing on the side is equal to the internal PIV divided by ``5,000``.

The point item score calculation uses the internal PIV value. The game calculates a point item's score as follows:

<!-- explain calculation of v3 -->
[code]item_score = (piv * 10000) / 5000 + 10000 / 2 // if version it becomes "item_score = 2 * piv + 5000"
item_score = truncate_to_nearest_ten(item_score)
if (item_score <= 0) {
    item_score = 10
}
[/code]

For example, if your PIV is ``161,803``, then ``item_score`` is  ``328,600``. If your PIV is ``271,828``, then ``item_score`` should be ``548,650``, but instead we get a value of ``10`` meaning that ``item_score`` somehow had less than a 1 score. [hl2]The reason why the if-condition is met is because there is an overflow happening.[/hl2]


### Integer overflow
[hr_minor]

A 32-bit signed integer uses 32 bits to represent whole numbers with one bit reserved for the sign (positive or negative). The value range is ``[-2,147,483,648; 2,147,483,647]``. When a 32-bit signed integer exceeds its maximum value (2,147,483,647), it wraps around due to fixed bit width. For example, adding ``1`` to ``2,147,483,647`` results in ``âˆ’2,147,483,648`` (this behavior is defined by two's complement arithmetic, which is the standard method for representing signed integers in most computing systems).

The issue arises in the line ``item_score = (piv * 10000) / 5000 + 10000 / 2``, or more specifically, ``piv * 10000``

Let's take the example of ``piv = 271828``. If the game runs this calculation, we get the following result:

[code]piv * 10000 = 271828 * 10000 = -1576687296 (overflowed value of 2718280000)[/code]

Continuing the ``item_score = (piv * 10000) / 5000 + 10000 / 2`` calculation results in a negative ``item_score`` value, meaning its final value becomes ``10`` score.

Earlier I stated that this bug happens in the PIV ranges [42.95, 85.4] or [128.85, 171.30]. If we convert the PIV ranges to the internal PIV ranges we obtain ``[214750, 427000]`` or ``[644250, 856500]``, which checks out with the item score calculation.

### Chart
[hr_minor]

Below a chart is depicted comparing the bugged PIV with the intended PIV. 

<!-- show score chart -->

[img=bugs/th20/0_piv_overflow_plot.png, figtitle=A plot with lines plotting the bugged PIV value and the intended PIV value. The [hl2]inflection points[/hl2] are at [hl2]42.95, 85.4, 128,85, and 171,30[/hl2]. It is clear that this bug reduces the amount of score gained, especially at very high PIV. For example, at the maximum PIV the bugged value gets 7.5x less score than the intended value. , alt=A plot comparing the bugged PIV value to the intended PIV value]

[hr_major]
## [links]
[hr_minor]

### [misc]
[hr_minor]

+ [cite=sKa9cpdkeL]
