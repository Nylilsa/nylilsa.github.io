[title=PCB: Merlin Glitch]  
# Merlin Glitch
  
[hr_major]  
## [specs]  
[hr_minor]

* **Versions**: [unknown]1.00[/unknown] - [unknown]1.00a[/unknown] - [yes]1.00b[/yes]
* **Difficulty**: [yes]Easy[/yes] - [yes]Normal[/yes] - [yes]Hard[/yes] - [yes]Lunatic[/yes] - [no]Extra[/no] - [no]Phantasm[/no]
* **Mode**: [yes]Main game[/yes] - [yes]Practice mode[/yes]
* **Shottype**: [no]ReimuA[/no] - [no]ReimuB[/no] - [no]MarisaA[/no] - [no]MarisaB[/no] - [yes]SakuyaA[/yes] - [yes]SakuyaB[/yes]


## [what]
[hr_minor]

Merlin behaves weirdly during and after the final spell-card.

[img=bugs/th07/0_merlin.png, hratio=2, other= ] [br]

There have been a number of reports in which Merlin bugged out. During this, there are various things Merlin does that doesn't make much sense.
Once, she kept moving around in circles, even after her final spell-card had happened.
Another time, she still attacked even though the fight has already ended.
Other times, she doesn't despawn after the final spell-card.

Replays are compatible with this bug.
This glitch is extraordinarily rare. All current replays/videos related to the glitch can be found in the [a=http://127.0.0.1:8887/#/bugs/th07/0#links]Links[/a] section of this page.

## [how]
[hr_minor]

The details to do this glitch are quite specific. They are as follows.

1. Play as Sakuya. This ensures you face Merlin during the first half of the fight.
2. End Merlin's 2nd non-spell during [hl2]a specific 16-frame window[/hl2].
3. On Hard/Lunatic, end [hl2]the 1st spell during a specific time[/hl2]. The time frame is quite large.
4. Target Merlin during the 1st spell.
5. End Merlin's 3rd non-spell during [hl2]a specific 16-frame window[/hl2].
6. End Merlin's solo spell during [hl2]a very specific 16-frame window[/hl2].

The reasons for the specific timings is described below.

### Merlin's subroutines - non-spell 2
[hr_minor]

A subroutine is a set of instructions designed to perform a frequently used operation within a program. Merlin frequently uses subroutines to spawn particle effects and to shoot bullets. Below I denote the subroutines that are involved with the precisely-timed kills.

For non-spell 2, the subroutine is as follows:
[code]void sub80() { // Merlin's 2nd non-spell
    [...]
    loop {
        sub81(1.7671459); // sub81 is the stuff Merlin shoots
+30: // 130
        sub60(30, 0.8); // sub60 makes Merlin move randomly - irrelevant
+30: // 160
        sub81(-1.7671459);
+30: // 190
        sub60(30, 0.8);
+100: // 290
        sub81(-1.7671459);
        sub81(1.7671459);
        sub81(-1.7671459);
+50: // 340
        sub60(30, 1.2);
+50: // 390
    }
}[/code]

[code]void sub81(float FPAR_0) { // what Merlin shoots during non-spell 2
    sub2(4, 32); // particle effects right before she shoots bullets
    [...] // stuff she shoots
}[/code]

[code]void sub2(int IPAR_0, int IPAR_1) { // spawns particle effects - lasts for exactly 16 frames
    I4 = IPAR_0;
    effect_sound(Sound5);
    do {
        effect_particle(Effect17, IPAR_1, 0xff8080ff);
+4: // 4
    } while (--I4);
    ret();
}[/code]

So this might be a bit confusing, but I will explain what is going on during the 2nd non-spell.
Firstly, the subroutine ``sub80`` is called. This is Merlin's 2nd non-spell. Now, ``sub80`` can also call for other functions, such as ``sub60`` and ``sub81``. In this case, we want to look at ``sub81``, which is the one responsible for shooting the bullets. ``sub81`` happens to call for ``sub2``, which is responsible for these little particle effects she calls for before attacking. ``sub2`` lasts for exactly 16 frames.
So assuming we start the fight from the 2nd non-spell ``sub80``, Merlin's [hl2]call stack[/hl2] *can* look as follows: ``sub80 → sub81 → sub2``.
I put the word *can* in italics because the call stack can also be different. For example, it can look like this ``sub80 → sub81`` or even this ``sub80``! But note: it cannot be ``sub80 → sub60`` because ``sub60`` is executed instantly.
But wait, how exactly does this work? 
In essence, [hl2]every subroutine lasts for a certain amount of frames[/hl2]. Let's take a look at the code for ``sub80`` again:

[code]void sub80() { // Merlin's 2nd non-spell
    [...]
    loop {
        sub81(1.7671459); // lasts for 8 + 16f
+30: // lasts for 30f
        sub60(30, 0.8); // lasts for 0f
+30: // lasts for 30f
        sub81(-1.7671459);// lasts for 8 + 16f
+30: // lasts for 30f
        sub60(30, 0.8); // lasts for 0f
+100: // lasts for 100f
        sub81(-1.7671459); // lasts for 8 + 16f
        sub81(1.7671459); // lasts for 8 + 16f
        sub81(-1.7671459); // lasts for 8 + 16f
+50: // lasts for 50f
        sub60(30, 1.2); // lasts for 0f
+50: // lasts for 50f
    }
}[/code]
Basically, when the game says ``+50:``, it means that Merlin [hl2]doesn't do anything for 50 frames long[/hl2]. During this time, if we were to end the 2nd non-spell, the call stack would look as follows: ``sub80``.
Secondly, suppose I were to end the 2nd non-spell [hl2]while Merlin is shooting her bullets[/hl2]. She is calling for ``sub81``, but in this case she is not calling for ``sub2``.  Because of this, the call stack would look as follows: ``sub80 → sub81``. 
Thirdly, suppose I were to 2nd the 2nd non-spell [hl2]right before Merlin shoots her bullets[/hl2], so while the particle effects are spawning. She calls for ``sub81``, which calls for ``sub2``. The call stack would look as follows: ``sub80 → sub81 → sub2``. 

Now, [hl2]it's possible to calculate the chance to get the call stack ``sub80 → sub81 → sub2``[/hl2] assuming the probability of the time at which the pattern was killed is [hl2]uniformly distributed[/hl2] (i.e. the chances of killing Merlin during the 386th frame is the same as killing her on the 1024th frame). [hl2]This doesn't reflect real chances[/hl2] due to the fact players would want to speedkill Merlin and this may get consistent kills, but this is the least we could work with.

The entire subroutine ``sub80`` lasts for ``380f`` before it loops. Out of the ``380f``, ``260f`` is spend doing nothing. During other ``120f`` she is busy with attacking. Out of the ``120f``, there are ``80f`` where she is busy with calling for ``sub2``. 
So, [hl2]there is a ``80/380`` chance for Merlin to exit the 2nd non-spell[/hl2] with the call stack ``sub80 → sub81 → sub2``. 

If you are reading this, it means I am currently busy with explaining this. I will add more information soon though !!!

## [why]
[hr_minor]

Soon:tm:

[hr_major]
## [links]
[hr_minor]
### [rpy]
[hr_minor]

+ [replay=6QslRdYpws]
+ [replay=PLv0zArCHT]
+ [replay=26nmhATHmN]
+ [replay=vSEJqDuDmA]

### [vid]
[hr_minor]

+ [cite=5JhFz2rmrG]
+ [cite=HRlIq8klSl]
+ [cite=i1O1kChzeC]
+ [cite=EWQEGVhayi]
