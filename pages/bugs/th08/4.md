[title=IN: The 2038 problem]
# The 2038 problem
[hr_major]

## [specs]
[hr_minor]

* **Versions**: [unknown]1.00[/unknown] - [unknown]1.00a[/unknown] - [unknown]1.00b[/unknown] - [unknown]1.00c[/unknown] - [yes]1.00d[/yes]
* **Difficulty**: [yes]Easy[/yes] - [yes]Normal[/yes] - [yes]Hard[/yes] - [yes]Lunatic[/yes] - [yes]Extra[/yes] - [yes]Last Word[/yes]
* **Mode**: [yes]Main game[/yes] - [yes]Practice mode[/yes] - [yes]Spell Practice[/yes]
* **Shottype**: [yes]Border Team[/yes] - [yes]Magic Team[/yes] - [yes]Ghost Team[/yes] - [yes]Scarlet Team[/yes] - [yes]Reimu[/yes] - [yes]Yukari[/yes] - [yes]Marisa[/yes] - [yes]Alice[/yes] - [yes]Youmu[/yes] - [yes]Yuyuko[/yes] - [yes]Sakuya[/yes] - [yes]Remilia[/yes]

## [what]
[hr_minor]

If your computer's date is after the timestamp 19th of January 2038, 03:14:07 UTC, your game will likely crash.

[img=https://imgs.xkcd.com/comics/2038.png, figtitle=Relevant xkcd (https://xkcd.com/607/)., alt=xkcd 607 is shown, describing the issue of the year 2038.]

## [how]
[hr_minor]

This happens if your computer's date is after the timestamp 19th of January 2038, 03:14:07 UTC. [hl2]The crash only happens once finishing a credit[/hl2], whether it is a gameover or a 1cc. Attempting to go to the Results screen crashes the game.

## [why]
[hr_minor]

This bug only happens when going to the Result screen. This is because when going to the Results screen, internally the following code is run:

[code]#include <time.h>

void GetMonthDay(char *buffer)
{
    __time32_t t;
    struct tm *tm_info;

    // Get current time as 32-bit time_t
    __time32(&t);

    // Convert to local time structure
    tm_info = _localtime32(&t);

    // Format the date as "MM/DD"
    _strftime(buffer, 6, "%m/%d", tm_info);
}
[/code]

(For technical readers, the code can be found at ``0x456938`` in 1.00d.)

This code fetches the current time and formats the date in a ``MM/DD`` format, which is then saved in your scorefile. Note that it does not keep track of the year, which is a design choice made by ZUN.

### Overflow

The Unix ``time_t`` data type that represents a point in time is a [hl2]32-bit signed integer[/hl2]. A signed 32-bit time value covers about 68 years before and after the Unix epoch (Jan 1st, 1970): the minimum date is Friday 1901-12-13, and the maximum date is Tuesday 2038-01-19. One second after the 19th of January 2038, 03:14:07 UTC, ``time_t`` overflows. This issue is also known as [hl2]the Year 2038 Problem[/hl2]. 

[hl2]When ``time_t`` overflows, the signs "flips", meaning that the time ``time_t`` actually represents is now in the year 1901[/hl2]. Below is a table showing the correct time along with the bugged time.

|       Actual time       |        Unix time         |            Bugged time             |
| :---------------------: | :----------------------: | :--------------------------------: |
| 2038-01-19 03:14:05 UTC | 2147483645 (0x7FFFFFFD)  |      2038-01-19 03:14:05 UTC       |
| 2038-01-19 03:14:06 UTC | 2147483646 (0x7FFFFFFE)  |      2038-01-19 03:14:06 UTC       |
| 2038-01-19 03:14:07 UTC | 2147483647 (0x7FFFFFFF)  |      2038-01-19 03:14:07 UTC       |
| 2038-01-19 03:14:08 UTC | -2147483648 (0x80000000) | [hl1]1901-12-13 20:45:52 UTC[/hl1] |
| 2038-01-19 03:14:09 UTC | -2147483647 (0x80000001) | [hl1]1901-12-13 20:45:53 UTC[/hl1] |
| 2038-01-19 03:14:10 UTC | -2147483646 (0x80000002) | [hl1]1901-12-13 20:45:54 UTC[/hl1] |

[br]

The call ``__time32`` stores the current time as a signed 32-bit ``time_t``. This means that for the first ``2^31 - 1`` values of unix time, the value is displayed correctly. When it surpasses ``2^31 - 1``, the number is now presented as a negative number. When ``_localtime`` converts this invalid value to the struct ``tm_info``, it produces incorrect or undefined date components, eventually leading to a crash. Essentially, this function assumes ``time_t`` is always valid, but after 2038 it no longer can represent the correct calendar date.

[hr_major]
## [links]
[hr_minor]
### [rpy]
[hr_minor]

Since this bug involves a consistent crash at a given time, it is not possible to create a replay that comes from after 2038.

### [vid]
[hr_minor]

No videos yet.

### [misc]
[hr_minor]

+ [cite=vQ89JNPKIo]
+ [cite=8MpPnwPlyX]

[buildCategoriesTable]