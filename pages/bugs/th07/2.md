[title=PCB: Laser Midpoint Bug]  
# Laser Midpoint Bug
[hr_major]

## [specs]  
[hr_minor]

* **Versions**: [unknown]1.00[/unknown] - [unknown]1.00a[/unknown] - [yes]1.00b[/yes]
* **Difficulty**: [yes]Easy[/yes] - [yes]Normal[/yes] - [yes]Hard[/yes] - [yes]Lunatic[/yes] - [yes]Extra[/yes] - [yes]Phantasm[/yes]
* **Mode**: [yes]Main game[/yes] - [yes]Practice mode[/yes]
* **Shottype**: [yes]ReimuA[/yes] - [yes]ReimuB[/yes] - [yes]MarisaA[/yes] - [yes]MarisaB[/yes] - [yes]SakuyaA[/yes] - [yes]SakuyaB[/yes]

## [what]
[hr_minor]

When a straight laser spawns, there is a small period of time before the laser fully appears and disappears. During these times, the laser only shows a thin warning line that warns the player about a spawning/despawning laser. This warning line usually does not have a hitbox except in one spot, which is in the middle of the laser.

[img=bugs/th07/2_midpoint_laser.png, figtitle=ReimuB is being hit by a laser as the laser is despawning, which should not happen., alt=An in-game screenshot of ReimuB dying to Alice's attack.]

## [how]
[hr_minor]

This bug can be replicated by being at the midpoint of the laser while the laser is spawning or despawning naturally: if a laser despawns by getting cancelled, then this midpoint bug will not occur. Since it is the midpoint, it is rather small. On top of this, the hitbox only stays for a few frames. In PCB, this bug can happen on almost any attack that features a laser. Below is a table listing every section of the game with a laser, and whether it's possible to get hit on the spawning phase, or on the despawning phase.

|            Pattern             |     Spawning      |           Despawning            |
| :----------------------------: | :---------------: | :-----------------------------: |
|     Alice's mid-spell-card     |     Yes (20f)     |            Yes (16f)            |
|     Merlin's 2nd non-spell     |     Yes (34f)     |               No*               |
|     Merlin's 3rd non-spell     |     Yes (10f)     |            Yes (20f)            |
|  Prismrivers' 3rd spell-card   |     Yes (14f)     |            Yes (16f)            |
|  Prismrivers' 4th spell-card   |    Yes (104f)     |               No*               |
|    Yuyuko's 1st spell-card     |       No**        |            Yes (20f)            |
|    Yuyuko's 7th spell-card     |     Yes (30f)     |            Yes (36f)            |
|      Ran's 3rd spell-card      |     Yes (10f)     |            Yes (30f)            |
|  Ran's 6th spell-card (blue)   | No, No, Yes (30f) | Yes (16f), Yes (16f), Yes (32f) |
|   Ran's 6th spell-card (red)   |        No         |            Yes (32f)            |
|      Ran's 9th spell-card      |        No         |               No*               |
|    Yukari's 3rd spell-card     |     Yes (10f)     |            Yes (30f)            |
|    Yukari's 4th spell-card     |        No         |            Yes (30f)            |
|    Yukari's 5th spell-card     |        No         |            Yes (30f)            |
| Yukari's 6th spell-card (blue) | No, No, Yes (30f) | Yes (16f), Yes (16f), Yes (32f) |
| Yukari's 6th spell-card (red)  |        No         |            Yes (32f)            |
|    Yukari's 9th spell-card     |        No         |               No*               |

[br]

*While the despawning conditions are met, the lasers take longer to despawn than what the attack lasts for, rendering it not possible.
**While the spawning conditions are met, it cannot actually happen because the laser midpoint is offscreen for the entire duration of the spawning phase.

Ran and Yukari's 6th spell-card has three different values. This is because the lasers there are different from one another.

## [why]
[hr_minor]

The tiny hitbox at the midpoint has a width equal to the full width of the laser, and a height equal to the visual width of the laser. [hl2]Presumably, ZUN intended for lasers hitbox's length to match the laser length and the width to match the visual width of the laser.[/hl2] This way, the laser's hitbox would get wider as the laser sprite thickens right before fully materializing, and shrink as the sprite thins when it begins to despawn. However, it seems like ZUN accidentally mixed up the fields for hitbox width and height.

[img=bugs/th07/2_laser_hitbox_corrected.png, figtitle=This image compares the current hitbox with the possible intended fix. (1) Current laser. (2) Fixed laser. While this does make more sense, it also means that there is a smaller hitbox in the fixed laser now., alt=Two lasers, one not fixed and the other fixed.]

But why does this sometimes happen with some lasers? To understand the cause of this bug, we must first understand how lasers work in this game.

### Laser States
[hr_minor]

A laser progresses through five visual states over its lifetime. They are explained through the following figure:

[img=bugs/th07/2_laser_states.png, figtitle=This image shows all laser states labelled 1 (left) through 5 (right). (1) Spawning laser without hitbox. (2) Spawning laser with hitbox. (3) Active laser. (4) Despawning laser with hitbox. (5) Despawning laser without hitbox., alt=Four lasers, each representing a different state from left to right.]

In the code, a laser can take many parameters, but we will be focussing only on the following parameters:
+ ``hitbox_start_time``: time until laser's partial hitbox materializes (state 1 -> state 2)
+ ``start_time``: time until laser fully materializes (state 1 -> state 3)
+ ``duration``: time the laser is active for (state 3 -> state 4)
+ ``hitbox_end_delay``: time the laser's partial hitbox is active for (state 4 -> state 5)
+ ``despawn_duration``: time until the laser fully despawns (state 4 -> despawn)

A rough pseudocode layout is shown below describing the logic of the states and parameters:

[code]laser_state = SPAWNING
timer = 0

while (true) {
    if (laser_state == SPAWNING) {
        if (timer >= hitbox_start_time) {
            activate_laser_midpoint_hitbox()
        }   

        if (timer >= start_time) {
            laser_state = ACTIVE
            timer = 0
        }
    }
    if (laser_state == ACTIVE) {
        if (timer < duration) {
            activate_laser_hitbox()
        } else {
            laser_state = DESPAWNING
            timer = 0
        }   
    }
    if (laser_state == DESPAWNING) {
        if (timer < hitbox_end_delay) {
            activate_laser_midpoint_hitbox()
        }
        if (timer >= despawn_duration) {
            despawn_laser()
        }
    }
    timer++
}
[/code]

### Hitbox while spawning (states 1, 2) 
[hr_minor]

[code]if (laser_state == SPAWNING) {
    if (timer >= hitbox_start_time) {
        activate_laser_midpoint_hitbox()
    }   

    if (timer >= start_time) {
        laser_state = ACTIVE
        timer = 0
    }
}
[/code]

For the laser to only have the hitbox in its midpoint, it means that ``time >= hitbox_start_time`` must be ``true`` and ``time >= start_time`` must be ``false``, or to put it simply, ``hitbox_start_time < start_time`` must be ``true``. The duration the midpoint will have a hitbox is equal to ``start_time - hitbox_start_time``.

### Hitbox while despawning (states 4, 5) 
[hr_minor]

[code]if (laser_state == DESPAWNING) {
    if (timer < hitbox_end_delay) {
        activate_laser_midpoint_hitbox()
    }
    if (timer >= despawn_duration) {
        despawn_laser()
    }
}
[/code]

For the laser to only have the hitbox in its midpoint, it means that ``time < hitbox_end_delay`` must be ``true`` and ``time >= despawn_duration`` must be ``false``, or to put it simply, ``hitbox_end_delay > 0`` must be ``true``. Every laser in PCB has ``hitbox_end_delay > 0``, so it means every laser has a hitbox in its midpoint while despawning. The duration the midpoint will have a hitbox is equal to ``min(hitbox_end_delay, despawn_duration)``.

[hr_major]
## [links]
[hr_minor]
### [rpy]
[hr_minor]

+ [replay=L7Vrojb1Z8]
+ [replay=3kmrDa1hVb]

### [vid]
[hr_minor]

[buildCategoriesTable]