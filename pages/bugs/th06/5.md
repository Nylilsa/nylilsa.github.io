[title=EoSD: Bomb Despawning Enemies]
# Bomb Despawning Enemies
[hr_major]

## [specs]  
[hr_minor]

* **Versions**: [unknown]1.00[/unknown] - [unknown]1.01[/unknown] - [unknown]1.02[/unknown] - [unknown]1.02a[/unknown] - [unknown]1.02b[/unknown] - [unknown]1.02c[/unknown] - [unknown]1.02d[/unknown] - [unknown]1.02e[/unknown] - [unknown]1.02f[/unknown] - [yes]1.02h[/yes]
* **Difficulty**: [yes]Easy[/yes] - [yes]Normal[/yes] - [yes]Hard[/yes] - [yes]Lunatic[/yes] - [yes]Extra[/yes]
* **Mode**: [yes]Main game[/yes] - [yes]Practice mode[/yes]
* **Shottype**: [yes]ReimuA[/yes] - [yes]ReimuB[/yes] - [yes]MarisaA[/yes] - [yes]MarisaB[/yes]

## [what]
[hr_minor]

Using a bomb sometimes causes enemies to despawn. This only applies to enemies coming from the right side of the screen.

<!-- (insert screenshot of stage 6 right before midboss, only one enemy showing up from side) -->

[img=bugs/th06/5_stage6.png, figtitle=Enemies from only the left side show up, but some of the enemies from the right side fail to show up., alt=A screenshot of the end section of Stage 6 of EoSD]

## [how]
[hr_minor]

Use a bomb right as an enemy is about to appear from off-screen. This more notably happens when the [hl2]screen-shaking effect is extremely violent[/hl2], which is with the shottypes ReimuB and MarisaB.

## [why]
[hr_minor]

To know why this happens, we must first understand what makes an enemy despawn, and what bombing does to the screen.

### Despawning conditions
[hr_minor]

For an enemy to despawn by leaving the screen, exactly two conditions must be fulfilled:
1. The enemy must [hl2]have been in bounds before[/hl2] at least once: [ins=2, n=7] must be true,
2. The enemy must [hl2]currently be out of bounds[/hl2].

(The purpose of the first point is to prevent the enemy from immediately despawning if the enemy spawns from off-screen)

To check whether the enemy has been in bounds or not, the game checks if any part of the enemy's sprite is within bounds. In pseudo code, it is written as follows::

[code]boolean is_in_bounds(x, y, enemy_width, enemy_height):
    if (x + enemy_width / 2) < 0:
        return false
    if (x - enemy_width / 2) > screen_width:
        return false
    if (y + enemy_height / 2) < 0:
        return false
    if (y - enemy_height / 2) > screen_height:
        return false
    return true
[/code]

The origin (0, 0) is in the top left of the screen. To give more information to the previous function, an image below is given showing the coordinate system in this game:

[img=bugs/th06/5_grid.png, figtitle=Screenshot showing the x- and y-coordinates of the game, alt=A screenshot showing the coordinates of the game]

Below is an example on how the enemy despawning process works:

[img=bugs/th06/5_enemy_despawning_process.png, figtitle=Three panels. First panel shows the enemy spawning from off-screen ([ins=2, n=7] = false, [ins=2, n=8] = false). The second panel shows that the enemy has entered the screen ([ins=2, n=7] = true, [ins=2, n=8] = true). The third panel shows the enemy exiting the screen and thus despawning ([ins=2, n=7] = true, [ins=2, n=8] = false), alt=Three screenshots of an enemy spawning, being on-screen and despawning]

### Screenshaking effect
[hr_minor]

The screenshake effect is an effect that modifies the position of the screen as well as the size of the screen. The logic for screenshaking goes as follows:
+ Pick a random number between 0 and 2.
+ Depending on the random number:
    + The screen's [hl2]position moves[/hl2] slightly
    + The screen's [hl2]dimensions decrease[/hl2] slightly
+ This logic is applied independently to both the X and Y axes. 

The second point "The screen's dimensions decrease slightly" is the only part of interest. Below is shown pseudocode of the relevant part of the screenshake effect.

[code]if (random_integer(0, 2) == 0) {
    screen_width = 384.0
} else {
    screen_width = 384.0 - screen_offset
}

if (random_integer(0, 2) == 0) {
    screen_height = 448.0
} else {
    screen_height = 448.0 - screen_offset
}
[/code]

``screen_offset`` is calculated as follows:

[code]screen_offset(timer) = ((end_offset - start_offset) / effect_length) * timer + start_offset[/code]

This follows the linear equation ``y = mx + b`` with parameters:
+ ``y`` being the output (``screen_offset``)
+ ``m`` being the slope: (``end_offset`` - ``start_offset``) / ``effect_length``
+ ``x`` being the independent variable (``timer``) starting from 0
+ ``b`` being the y-intercept: ``start_offset``

The values of ``effect_length``, ``start_offset``, and ``end_offset`` are hardcoded values that are specific to each character. Below is a table summarising the values for every case.

| Shottype | Bomb Trigger condition | effect_length | start_offset | end_offset |
| -------- | ---------------------- | ------------- | ------------ | ---------- |
| ReimuA   | On orb explosion       | 16            | 8            | 0          |
| ReimuB   | First 60 frames        | 60            | 2            | 6          |
|          | After first 60 frames  | 80            | 20           | 0          |
| MarisaA  | First 120 frames       | 120           | 4            | 1          |
| MarisaB  | Frames 60-120          | 60            | 1            | 7          |
|          | After 120 frames       | 200           | 24           | 0          |

[br]

<!-- It follows that the maximum value of ``screen_offset`` is equal to ``max(start_offset, end_offset)``, which is ``screen_offset = 24`` with MarisaB as shottype. Below is an image that demonstrates ``screen_offset`` being 24: -->

The following image demonstrates the despawning process of a fairy. This has been done with ReimuB on Stage 6, with ``screen_offset`` being ``20`` on the x-axis.

<!-- show visual examples -->

[img=bugs/th06/5_offset_20_overlay.png, figtitle=Three panels. The first panel shows the enemy entering the screen ([ins=2, n=7] = true, [ins=2, n=8] = true). The second panel shows the screen shake effect with screen_offset = 20. The area in green is the area the field has been shrunk by ([ins=2, n=7] = true, [ins=2, n=8] = false). The third panel shows that the enemy on the right has despawned., alt=Three screenshots of an enemy being on-screen, going off-screen and therefore despawning prematurely]

### Pausing & desyncs
[hr_minor]

If you pause the game while the screen is shaking, the ``screen_width`` and ``screen_height`` reset to ``384.0`` and ``448.0`` respectively. This means that by repeatedly pause-buffering during periods where ``screen_offset`` is non-zero, you can manipulate the stage to retain a constant ``screen_width`` and ``screen_height`` of ``384.0`` and ``448.0`` respectively. However, [hl2]performing this action will likely desync your replay[/hl2]. When watching back the replay, [hl2]the ``screen_width`` and ``screen_height`` will not retain their initial values[/hl2] but will instead fluctuate based on ``screen_offset``, which will despawn any entities that otherwise would have been there. Likewise, pause-buffering during a bomb will have the same effect where the replay may desync. 

[hr_major]
## [links]
[hr_minor]
### [rpy]
[hr_minor]

None yet

### [vid]
[hr_minor]

None yet

[buildCategoriesTable]