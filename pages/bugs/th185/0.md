[title=HBM: Tsukasa No Bullets]
# Tsukasa No Bullets
[hr_major]

## [specs]  
[hr_minor]

* **Versions**: [yes]1.00a[/yes]
* **Stage**: [no]Tutorial[/no] [no]1st Market[/no] [no]2nd Market[/no] [no]3rd Market[/no] [no]4th Market[/no] [yes]5th Market[/yes] [no]6th Market[/no] End [no]of Market[/no] [no]Challenge Market[/no]

## [what]
[hr_minor]

Tsukasa can stops shooting bullets on her first spell. This effect does not take place in the other stages.
[img=bugs/th185/0_no_bullets.png, figtitle=A screenshot of Tsukasa's first spell-card showing not many bullets. More rows are supposed to spawn but they fail to spawn., alt=Marisa fighting against Tsukasa on her first spell-card]

## [how]
[hr_minor]

[hl2]The player must repeatedly die on Tsukasa's first spell[/hl2]. This actions must be done at specific times, particularly right after Tsukasa shoots her large bullets. This must be done until ``2,000`` bullets have prematurely been cleared.

## [why]
[hr_minor]

Tsukasa's first spell creates invisible bullets that spawn after a few game ticks. The invisible bullets count towards the bullet cap, which is set at ``2,000``. If the bullet cap of ``2,000`` is reached and enemies tries to fire its pattern, no bullets will be shot.

The bullets use an ECL instruction called [ins=0, n=611]. This ECL instruction adds a transformation to the bullet, which is set with [ins=0, n=611]'s argument ``type``. In this glitch, this value is equal to ``67108864``, or ``0x04000000`` in hexadecimal.

For simplicity, I will use a [a=https://priw8.github.io/#s=MERLIN/doc/functions/transformations]MERLIN macro[/a] that makes it easier to understand the explanation. Using the macro, the value ``0x04000000`` corresponds to [ins=2, n=BulletEffectType-67108864]. This bullet transformation hides the bullet for ``time``. During this time, it will [hl2]be invisible, not move, and not have a hitbox[/hl2].

### The flag [ins=2, n=6]
[hr_minor]

When a bullet of transfomation ``0x04000000`` is set, the bullet sets an [hl2]internal flag[/hl2] called [ins=2, n=6]. While this flag is set, the bullet will be invisible and not have a hitbox. This flag is cleared once ``time`` frames have passed.

When a bullet with [ins=2, n=BulletEffectType-67108864] is spawned, the following sequence of events happen:
1. The bullet is created by the boss and is linked to the bullet list
2. The bullet's internal flag [ins=2, n=6] is set to ``true``.
3. The bullet waits until ``time`` frames have passed.
4. The bullet's internal flag [ins=2, n=6] is set to ``false``. The bullets is now visible and tangible. 

### Removing the bullet from the bullet list
[hr_minor]

The bullet list is a list of all bullets that have been fired by enemies and are currently active. This list is updated every game-tick and has a capacity of ``2,000``. In other words, at most ``2,000`` bullets can exist at once. If this limit has been reached and any more patterns are shot, the new bullets will fail to appear. This list also keeps track of bullets of transformation ``0x04000000`` despite those bullets visually not having appeared yet.

When a bullet is destroyed, the following sequence of events happen:

1. The bullet is destroyed (by dying or cancelling).
2. The bullet's [hl2]state variable[/hl2] changes from ``1`` (normal) to ``4`` (in the process of being cleared).
3. If the flag [ins=2, n=6] is [hl2]not set[/hl2], then the bullet is removed from the bullet list.

The last step checks if flag [ins=2, n=6] is [hl2]not set[/hl2] to prevent any animation-related bugs.  

### Clearing the bullet while the flag [ins=2, n=6] is set
[hr_minor]

We can now combine the knowledge of the previous two sections. Suppose that the bullet is cleared while the flag [ins=2, n=6] is ``true``. The following sequence of events happen:

1. The bullet is created by the boss and is linked to the bullet list
2. The bullet's internal flag [ins=2, n=6] is set to ``true``.
3. The bullet waits until ``time`` frames have passed.
4. [hl2]Before ``time`` frames have passed, the bullet is destroyed[/hl2].
5. The bullet's [hl2]state variable[/hl2] changes from ``1`` to ``4``.
6. The flag [ins=2, n=6] is [hl2]set[/hl2], therefore the bullet is not removed from the bullet list.

Since the state variable is ``4``, [hl2]some transformations that are set by [ins=0, n=611] are skipped, which includes the transformation ``0x04000000``[/hl2]. In the example of [ins=2, n=BulletEffectType-67108864], it means that [hl2]any instructions[/hl2] related to the ``time`` variable are [hl2]skipped[/hl2]. As a result, the bullet's internal flag [ins=2, n=6] cannot change and will stay ``true``.

The result of this is that [hl2]the bullet remains in a state taking up a slot in the bullet list while never visually appearing on-screen and being intangible[/hl2].


[hr_major]
## [links]
[hr_minor]

### [vid]
[hr_minor]


[buildCategoriesTable]