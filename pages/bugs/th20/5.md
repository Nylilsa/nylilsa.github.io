[title=FW: Stone Timer Desync]
# Stone Timer Desync
[hr_major]

## [specs]  
[hr_minor]

* **Versions**: [yes]1.00a[/yes]
* **Difficulty**: [yes]Easy[/yes] - [yes]Normal[/yes] - [yes]Hard[/yes] - [yes]Lunatic[/yes] - [no]Extra[/no]
* **Mode**: [yes]Main game[/yes] - [no]Practice mode[/no] - [no]Spell practice[/no]  
* **Shottype**: [yes]Reimu[/yes] - [yes]Marisa[/yes]

## [what]
[hr_minor]

A seemingly abrupt desync could appear in the replay. If a side by side comparison would be made (one desyncing and the other not desyncing) it would appear that the desynced replay can summon a stone one frame off than intended. [hl2]This desync only takes place during a boss or mid-boss[/hl2]. This bug only affects stages after Stage 1: [hl2]Stages 2 through 6[/hl2]. In other words, only main game credits are counted: stage practice, spell practice, and Extra are not affected. 

[img=bugs/th20/5_stone_desync.png, figtitle=Two screenshots of the same replay. The left side does not desync while the right side does desync. The right side summons a stone one frame earlier than intended, resulting in a desync., alt=Two in-game screenshot of two Reimus with one side spawning a stone and the other side not spawning a stone.]

## [how]
[hr_minor]

There is only one way in which this desync can happen, which is by [hl2]starting a replay directly from a stage between Stages 2 through 6[/hl2]. This [hl2]desync is not guaranteed to happen[/hl2] but [hl2]common enough[/hl2] to usually encounter it at least once in a clear.

## [why]
[hr_minor]

During a boss or mid-boss, your stone gauge automatically increases by ``2`` every ``3`` frames. More specifically, the [hl2]stone gauge increments by ``1`` if ``timer % 3 < 2``[/hl2] where ``timer`` is a timer that increments by ``1`` for every frame [hl2]a boss or mid-boss is alive for[/hl2]. (For the technical readers, the value of ``timer`` is found at ``*(int*)(*(int*)(th20.exe + 0x1c6118) + 0x28 + 0x4)``.
)

However, [hl2]``timer`` is never saved in the replay[/hl2]. This means that [hl2]any replays starting from stages 2 through 6 have a 66.7% chance of having a wrong ``timer`` value[/hl2], resulting in an imbalance in your stone gauge. The imbalance in your stone gauge enables the replay to desync, though it does not mean a desync is guaranteed from it.

[hr_major]
## [links]
[hr_minor]
### [rpy]
[hr_minor]

None so far

<!-- 
### [vid]
[hr_minor]

None so far. -->

[buildCategoriesTable]